# 客服停權工具整合規格說明

## 需求背景/目的

- 現有停權無統一機制，導致作業費時，且無法針對細項功能(如商城購買、玩家交易)作停權。
- 設計一方便客服操作，並可針對設定的細項作停權設計，再透過網頁端將停權資訊發佈到各遊戲的停權工具。
- 各遊戲端可根據散佈的停權資訊，自行在遊戲內作處理判斷。

## 停權工具流程圖

![image-20210303122128506](images/image-20210303122128506.png)

## 遊戲端實作項目說明

1.實作停權工具散佈停權資訊的Store Procedure

   **(遊戲端需備Store Procedure規格說明 1~4)**

2.實作將需要公佈的停權資料加上遊戲帳號、伺服器、遊戲暱稱回傳GameTower_Web DB的機制

**ps.需公佈的停權資料為ForbidItem的[SHOW_REASON_FLAG]為True的停權資料**

**ps2.提供呼叫的Store Procedure請參照提供呼叫Store Procedure規格說明1~2**

3.實作網頁端檢查會員停權狀態的Store Procedure

​    **(遊戲端需備Store Procedure規格說明 5)**

## 散佈停權名單示意圖

![image-20210303122426648](images/image-20210303122426648.png)

## 遊戲端需備Store Procedure規格說明

1. 新增停權資訊
   ```
   函　　式：[Web_AddForbidRecord]
   功能說明：新增停權資料
   
   		@nForbidNo		停權單號
   		@nMemberNo		會員編號
   		@nItemNo		停權項目
   		@dtEffectiveDateTime	生效時間
   		@dtExpireDateTime	到期時間
   		@strReason		停權事由
   		@strWay		處分方式
   		@nGmMemberNo	客服GM的帳號
   
   傳回結果：		 
   		0		= 新增成功
   		-1		= 資料已存在(停權單號+ 會員編號+ 停權項目)
   		其他負數	= (SQL錯誤代碼+ 100000) * (-1) 
   ```
2. 移除停權資訊
   ```
   函　　式：[Web_RemoveForbidRecord]
   功能說明：移除停權資料
   
   		@nForbidNo		停權單號
   		@nMemberNo		會員編號
   		@nItemNo		停權項目
   
   傳回結果：		 
   		0		= 移除成功
   		-1		= 資料不存在(停權單號+ 會員編號+ 停權項目)
   		其他負數	= (SQL錯誤代碼+ 100000) * (-1)
   ```
3. 新增停權項目
   ```
   函　　式：[Web_AddForbidItem]
   功能說明：新增停權項目
   
   		@nItemNo		停權項目編號
   		@nItemName		停權項目名稱
   		@nItemId		停權項目識別ID
   		@bShowReasonFlag	是否要在前台顯示停權原因
   		@bInvalidFlag		是否停用
   
   傳回結果：		 
   		0		= 新增成功
   		-1		= 資料已存在(停權項目編號)
   		其他負數	= (SQL錯誤代碼+ 100000) * (-1)
   ```
4. 修改停權項目
   ```
   函　　式：[Web_ModifyForbidItem]
   功能說明：修改停權項目
   
   		@nItemNo		停權項目編號
   		@bShowReasonFlag	是否要在前台顯示停權原因
   		@bInvalidFlag		是否停用
   
   傳回結果：		 
   		0		= 修改成功
   		-1		= 資料不存在(停權項目編號)
   		其他負數	= (SQL錯誤代碼+ 100000) * (-1)
   ```
5. 查詢停權狀態
   ```
   函　　式：[Web_FORBID_CheckState]
   功能說明：檢查會員停權狀態
   
   		@nMemberNo				會員編號
   傳回結果：		 
   		STATE,FORBID_MESSAGE, EXPIRE_DATETIME
   
   		 STATE 回傳說明：
   		0		= 會員沒被停權
   		-1		= 會員已被停權			
   				(ForbidItem的[SHOW_REASON_FLAG]為True)
   		-2		= 會員已被停權			
   				(ForbidItem的[SHOW_REASON_FLAG]為False)
   		-3至-20為網頁組保留，如遊戲有其他實作訊息，請用 < -20的訊息
   
   		其他負數	= (SQL錯誤代碼+ 100000) * (-1) 
   
   		 FORBID_MESSAGE 回傳說明：狀態為-1時，網頁顯示給玩家的訊息
   		 EXPIRE_DATETIME 回傳說明：到期時間
   回傳範例： SELECT -1 AS STATE, '遊戲中嚴重吃餵牌' AS FORBID_MESSAGE,2009-03-15 00:00:00 as EXPIRE_DATETIME
   ```
## 提供呼叫Store Procedure規格說明

1. 新增停權名單資訊
   ```
   函　　式：[Web_FORBID_AddCommonRecord]
   功能說明：新增停權資料
   		@nGameProductNo	遊戲類型
   		@strAccount 		會員帳號
   		@strServerName 	伺服器
   		@strNickName		遊戲暱稱
   		@nForbidNo		停權單號
   		@nMemberNo		會員編號
   		@nItemNo		停權項目
   		@dtEffectiveDateTime	生效時間
   		@dtExpireDateTime	到期時間
   		@strReason		停權事由
   		@strWay		處分方式
   		
   傳回結果：		 
   		0	 = 新增成功
   		-1	 = 資料已存在(遊戲類型 +停權單號+ 會員編號+ 停權項目)
   		其他負數 = (SQL錯誤代碼+ 100000) * (-1) 
   ```
2. 移除停權名單資訊
   ```
   函　　式：[Web_FORBID_RemoveCommonRecord]
   功能說明：移除停權資料
   		@nGameProductNo	遊戲類型
   		@nForbidNo		停權單號
   		@nMemberNo		會員編號
   		@nItemNo		停權項目
   
   傳回結果：		 
   		0	 = 移除成功
   		-1	 = 資料不存在 (遊戲類型 +停權單號+ 會員編號+ 停權項目) 		其他負數 = (SQL錯誤代碼+ 100000) * (-1)
   ```

## 停權項目說明(請提供可能停權項目)

- 101-帳號停用(明停)
- 102-帳號停用(暗停)
- 103-帳號停用(待刪)
- 104-帳號停用(明停)加立即踢下線
- 105-帳號停用(暗停)加立即踢下線
- 201-禁止登入不秀原因
- 251-禁止登入強迫至特殊修改頁面
- 301-禁止登入
- 302-禁止商城交易
- 303-禁止玩家交易
- 304-禁言

## 注意事項

- Store Procedure請用SELECT回傳參數(ex. SELECT 0;)

- 遊戲端實作停權檢查時，如同時有SHOW_REASON_FLAG為True與False的資訊，請優先顯示True的停權資訊。

- 為避免同步停權資訊有誤差，遊戲端維修開機後請呼叫散佈頁面作同步處理。

  –開發機位置：http://admin.gt.web/common/routine/Forbid/ShareForbidList.aspx

  –測試機位置：http://admin-twtest.towergame.com/common/routine/Forbid/ShareForbidList.aspx

  –正式機位置：http://admin.gametower.com.tw/common/routine/Forbid/ShareForbidList.aspx